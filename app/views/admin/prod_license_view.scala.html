@import model.Product
@import model.Response
@import model.ProductLicense
@import dao.PingResponsesDAO
@import dao.ProductsDAO
@import util.FutureUtils._
@import dao.ResponsesDAO
@import dao.ProdLicensePingDAO
@import util.FutureUtils._
@import shapeless._
@import dao.PingExtrasDAO
@import scala.concurrent.Future
@import scala.concurrent.ExecutionContext.Implicits.global
@(prodLicense: ProductLicense)(implicit productsDAO: ProductsDAO, responsesDAO: ResponsesDAO, pingExtrasDAO: PingExtrasDAO, pingResponsesDAO: PingResponsesDAO, plpDAO: ProdLicensePingDAO)

@layout_admin_simple(s"Viewing license ${prodLicense.license} for product ${prodLicense.prod.name}") {
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Configuration</h3>
        </div>
        <div class="panel-body">
            <form class="row" action="@controllers.admin.prod.routes.ProductLicenses.setProductLicenseResponse(prodLicense.prod.id, prodLicense.license)" method="post">
                <input type="hidden" name="opt" value="unreg_response">
                <label for="" class="col-sm-4">Default response for all users of this license:</label>
                @defining(pingResponsesDAO.getExactResponse(Some(prodLicense.prod.id), Some(prodLicense.license), None).await) { resp =>
                    @snippet.responseselect(resp.map(_.id).getOrElse(-1))
                }
                <button type="submit" class="btn btn-primary btn-xs">Set</button>
            </form>
        </div>
    </div>

    <h3>Users using this license:</h3>
    <table class="table">
        <thead>
            <tr>
                <td>User</td>
                <td>Last used</td>
            </tr>
        </thead>
        <tbody>
            @for(ping <- plpDAO.findRecentUserPings(prodLicense).await) {
                <tr>
                    <td>@ping.user</td>
                    <td>@snippet.datetime(ping.date)</td>
                </tr>
            }
        </tbody>
    </table>

    <h3>Recent pings on this license:</h3>
    <table class="table">
        <thead>
            <tr>
                <td>User</td>
                <td>IP</td>
                <td>Timestamp</td>
                <td>Extra keys</td>
                <td>Response</td>
            </tr>
        </thead>
        <tbody>
        @for(ping :: extras :: response :: HNil <- plpDAO.findRecentPings(prodLicense, 15).await.map(p => hsequence(Future.successful(p) :: pingExtrasDAO.findExtras(p.id) :: p.queryResponse() :: HNil)) awaitAll) {
            <tr>
                <td>@ping.user</td>
                <td>@ping.ip</td>
                <td><a href="@controllers.admin.prod.routes.ProductLicenses.licenseView(prodLicense.prod.id, ping.license)">@ping.license</a></td>
                <td>@snippet.datetime(ping.date)</td>
                <td>
                @for(pe <- extras) {
                    <a class="btn btn-info btn-xs" role="button" data-toggle="popover" data-trigger="focus" data-ping-id="@ping.id" data-pingextra-key="@pe.key" data-valueurl="@controllers.admin.routes.Pings.showPingExtra(ping.id, pe.key)" href="@controllers.admin.prod.routes.ProductPingExtras.view(prodLicense.prod.id, pe.key)">
                    @pe.key
                    </a>
                }
                </td>
                <td>
                @response match {
                    case Some(resp) => {
                        <a href="@controllers.admin.routes.Responses.view(resp.id)" class="btn btn-xs btn-info">@resp.name</a>
                    }
                    case _ => { Empty }
                }
                </td>
            </tr>
        }
        </tbody>
    </table>
}