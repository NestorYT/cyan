@import dao._

@import scala.concurrent.Future
@import util.FutureUtils._
@import shapeless._
@import scala.concurrent.ExecutionContext.Implicits.global

@import model.Ping
@import cyan.backend.Backend
@(pings: Seq[Ping], showProducts: Boolean = false, showLicense: Boolean = true, showExtras: Boolean = true)(implicit productsDAO: ProductsDAO, pingExtrasDAO: PingExtrasDAO, responsesDAO: ResponsesDAO, backend: Backend = null)

<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                @if(showProducts) { <td>Product</td> }
                @if(showLicense) { <td>License</td> }
                <td>User</td>
                <td>IP</td>
                <td>Timestamp</td>
                @if(showExtras) { <td>Extra keys</td> }
                <td>Response</td>
            </tr>
        </thead>
        <tbody>
            @for(ping :: product :: extras :: response :: HNil <- pings.map(p => hsequence(Future.successful(p) :: p.queryProduct() :: p.queryExtras() :: p.queryResponse() :: HNil)) awaitAll) {
                <tr>
                    @if(showProducts) {
                        <td><a href="@controllers.admin.prod.routes.Products.view(product.id)">@product.name</a></td>
                    }
                    @if(showLicense) {
                        <td>
                            @Option(backend).map(be => be.transformLicenseHtml(ping.license)(_: Html)).getOrElse((x: Html) => x) {
                                <a href="@controllers.admin.prod.routes.ProductLicenses.licenseView(product.id, ping.license)">@ping.license</a>
                            }
                        </td>
                    }
                    <td>@ping.user</td>
                    <td>@ping.ip</td>
                    <td>@snippet.datetime(ping.date)</td>
                    @if(showExtras) {
                        <td>
                        @for(pe <- extras) {
                            <a class="btn btn-info btn-xs" role="button" data-toggle="popover" data-trigger="focus" data-ping-id="@ping.id" data-pingextra-key="@pe.key" data-valueurl="@controllers.admin.routes.Pings.showPingExtra(ping.id, pe.key)" href="@controllers.admin.prod.routes.ProductPingExtras.view(product.id, pe.key)">
                            @pe.key
                            </a>
                        }
                        </td>
                    }
                    <td>
                    @response match {
                        case Some(resp) => {
                            <a href="@controllers.admin.routes.Responses.view(resp.id)" class="btn btn-xs btn-info">@resp.name</a>
                        }
                        case _ => { Empty }
                    }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>